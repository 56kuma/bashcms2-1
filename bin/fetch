#!/bin/bash -euvx
source "$(dirname $0)/conf"
exec 2> "$logdir/$(basename $0).$(date +%Y%m%d_%H%M%S).$$"

echo 'Content-type: text/html'
echo

cd "$contentsdir"
git pull

### CREATE TIMESTAMP FILES IF NOT EXIST ###
find posts pages -maxdepth 1 -type d    |
grep /                                  |
while read d ; do
    [ -f "$contentsdir/$d/main.md" ] || continue
    mkdir -p "$datadir/$d"                     
    touch "$datadir/$d/main.md"               

    ### ADD CREATE TIME IF NECESARRY ###
    [ ! -f "$datadir/$d/created_time" ] &&   
    date "+%Y-%m-%d %H:%M:%S" > "$datadir/$d/created_time"

    ### CHANGE MODIFIED TIME IF NECESARRY ###
    ! diff "$contentsdir/$d/main.md" "$datadir/$d/main.md" &&
     cp "$contentsdir/$d/main.md" "$datadir/$d/main.md"     &&
     date "+%Y-%m-%d %H:%M:%S" > "$datadir/$d/modified_time"  

    continue
done
