#!/bin/bash -euvx
source "$(dirname $0)/conf"
exec 2> "$logdir/$(basename $0).$(date +%Y%m%d_%H%M%S).$$"

echo 'Content-type: text/html'
echo

cd "$contentsdir"
git pull

### CREATE DATADIRS ###
cd "$contentsdir"
find posts pages -maxdepth 1 -type d	|
grep /					|
xargs -I@ mkdir -p "$datadir/@"

### TIMESTAMP FILES IF NOT EXIST ###
cd "$datadir"
find posts pages -maxdepth 1 -type d	|
grep /					|
while read d ; do
	[ -f "$contentsdir/$d/main.md" ] || continue
	touch "$datadir/$d/main.md"

	[ ! -f "$datadir/$d/created_time" ] &&
	date "+%Y%m%d %H%M%S %N" > "$datadir/$d/created_time"

	! diff "$contentsdir/$d/main.md" "$datadir/$d/main.md"	&&
	cp "$contentsdir/$d/main.md" "$datadir/$d/main.md"	&&
	date "+%Y%m%d %H%M%S %N" > "$datadir/$d/modified_time"
done
